<!DOCTYPE html>
<html lang="pl">
  <head>
    <title>
    System.out.println
        - Konsolidacja baz mysql dla aplikacji KDE w openSUSE
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Mariusz Fik">
    <meta name="description" content="Static blog generated with JBake">

    <!-- Style -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.3.0/yeti/bootstrap.min.css">
    <link rel="stylesheet" href="/css/prettify-themes/github.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css">
    <link rel="stylesheet" href="/css/base.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav icon -->
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  </head>
  <body>
      
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">System.out.println</a>
        </div>
        
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="/pages/about.html">O mnie</a></li>
            <li><a href="/pages/contact.html">Kontakt</a></li>
          </ul>
        
        <!-- Right navigation -->
        <ul class="nav navbar-nav navbar-right">
          <li><a href="/archive.html"><i class="fa fa-list"></i> Archiwum</a></li>
          <li><a href="/feed.xml" title="Rss"><i class="fa fa-rss"></i> Rss</a></li>
        </ul>
        <!-- Right navigation end -->

      </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav><!-- /.navbar -->

    <!-- Begin page content -->
    <div class="container">
      
      <div class="row">
        <div class="col-md-12">
          <article>
            <div class="page-header"><h1>Konsolidacja baz mysql dla aplikacji KDE w openSUSE</h1>
              <ol class="breadcrumb tagsbar">
                <li><a href="/tags/KDE-SC.html">KDE-SC</a></li>
                <li><a href="/tags/openSUSE.html">openSUSE</a></li>
              </ol>
            </div>
          <p class="post-meta">
            <i class="fa fa-calendar"></i>&nbsp;21 listopada 2013&nbsp;&nbsp;
            <i class="fa fa-user"></i>&nbsp;Mariusz Fik&nbsp;&nbsp;
              <i class="fa fa-comment"></i>&nbsp;<span class="badge"><a href="http://fisiu.github.io/2013/konsolidacja-baz-mysql-dla-aplikacji-kde-w-opensuse.html#disqus_thread"></a></span>
          </p>
              <p><p>Pulpit plazmy korzysta z akonadi, które w domyślnej konfiguracji używa własnej instancji mysql/mariadb. Amarok przechowuje informacje o naszej bibliotece (notowania, teksty, oceny) również w bazie mysql. W tym celu korzysta również z własnej instancji. DigiKam domyślnie przechowuje informacji o kolekcji obrazów w bazie sqlite. Przy większych kolekcjach, może okazać się, że wydajność sqlite jest niewystarczająca. Nic nie stoi na przeszkodzie, aby wszystkie bazy przenieść do systemowej instancji mariadb. Dzięki temu unikniemy dublowania instancji baz dla akonadi i amaroka oraz przyspieszymy działanie digiKama.</p><p>I krótka legenda dla kodów użytych w tym wpisie.Kody zaczynające się od:</p>
<ul>
  <li># - należy wykonać jako root</li>
  <li>$ - należy wykonać jako zwykły użytkownik</li>
  <li>&gt; - należy wykonać w konsoli mysql/mariadb</li>
</ul><p>Zanim zaczniemy migrować bazy, należy zainstalować serwer mysql/mariadb i uruchomić go:</p><p><kbd># zypper in mariadb </kbd><br/><kbd># systemctl enable mysql </kbd><br/><kbd># systemctl start mysql </kbd></p>
<!-- more --><h3>Akonadi</h3><p>Upewniamy się, że akonadi działa:</p><p><kbd>$ akonadictl status </kbd></p><p>Tworzymy zrzut aktualnej bazy akonadi za pomocą:</p><p><kbd>$ mysqldump --socket=~/.local/share/akonadi/socket-$HOSTNAME/mysql.socket akonadi &gt; ~/akonadi-backup.sql </kbd></p><p>Zatrzymujemy serwer akonadi:</p><p><kbd>$ akonadictl stop </kbd></p><p>Zmieniamy konfigurację bazy danych akonadi, tak aby korzystała z zewnętrznego serwera mysql. Możemy edytować plik <code>~/.config/akonadi/akonadiserverrc</code> by jego zawartość wyglądała następująco:</p>
<pre><code>[%General]
Driver=QMYSQL
SizeThreshold=4096
ExternalPayload=false

[QMYSQL]
Name=akonadi
Host=localhost
Options=
ServerPath=/usr/sbin/mysqld
StartServer=false
User=akonadi
Password=akonadi

[Debug]
Tracer=null
</code></pre><p>Lub możemy uruchomić:</p><p><kbd>$ kcmshell4 akonadi </kbd></p><p>Odznaczamy 'Używaj wewnętrznego serwera MySQL' i uzupełniamy dane jak na rysunku poniżej.</p><p><img src="/img/2013/akonadi-system-mariadb.png" alt="akonadi-system-mariadb""/></p><p>Następnie konieczne jest dodanie bazy danych i użytkownika.</p><p><kbd>&gt; CREATE USER 'akonadi'@'localhost' IDENTIFIED BY 'akonadi'; </kbd><br/><kbd>&gt; CREATE DATABASE `akonadi`; </kbd><br/><kbd>&gt; GRANT ALL PRIVILEGES ON akonadi.* to 'akonadi'@'localhost' IDENTIFIED BY 'akonadi'; </kbd></p><p>Następnie należy przywrócić nasz zrzut bazy akonadi za pomocą:</p><p><kbd>$ mysql akonadi &lt; akonadi-backup.sql </kbd></p><p>Teraz pozostało nam już tylko uruchomić serwer akonadi za pomocą:</p><p><kbd>$ akonadictl start </kbd></p><p>Jeśli spotkamy się z błędem:</p>
<pre><code>Sql error: Table &#39;akonadi.SchemaVersionTable&#39; doesn&#39;t exist QMYSQL: Unable to execute query
</code></pre><p>należy zmienić nazwy table naszej bazy na format <a href="http://en.wikipedia.org/wiki/CamelCase">CamelCase</a>.</p><p><kbd>&gt; RENAME TABLE schemaversiontable TO SchemaVersionTable; </kbd><br/><kbd>&gt; RENAME TABLE resourcetable TO ResourceTable; </kbd><br/><kbd>&gt; RENAME TABLE collectionattributetable TO CollectionAttributeTable; </kbd><br/><kbd>&gt; RENAME TABLE collectionmimetyperelation TO CollectionMimeTypeRelation; </kbd><br/><kbd>&gt; RENAME TABLE collectionpimitemrelation TO CollectionPimItemRelation; </kbd><br/><kbd>&gt; RENAME TABLE collectiontable TO CollectionTable; </kbd><br/><kbd>&gt; RENAME TABLE flagtable TO FlagTable; </kbd><br/><kbd>&gt; RENAME TABLE mimetypetable TO MimeTypeTable; </kbd><br/><kbd>&gt; RENAME TABLE parttable TO PartTable; </kbd><br/><kbd>&gt; RENAME TABLE pimitemflagrelation TO PimItemFlagRelation; </kbd><br/><kbd>&gt; RENAME TABLE pimitemtable TO PimItemTable; </kbd></p><p>Od teraz akonadi będzie korzystało z systemowej instancji mysql/mariadb.<br/>Możliwe są dalsze <a href="http://cgbdx.wordpress.com/2011/07/21/how-to-setup-your-external-sql-server-for-akonadi/">optymalizacje</a> bazy danych, adekwatne do <a href="https://projects.kde.org/projects/kdesupport/akonadi/repository/revisions/master/entry/server/src/storage/mysql-global.conf">konfiguracji</a> używanej przez dedykowaną instancję bazy.</p><h3>Amarok</h3><p>Zatrzymujemy serwer mysql/mariadb:</p><p><kbd># systemctl stop mysql </kbd></p><p>Uruchamiamy serwer tylko z bazą amaroka:</p><p><kbd>$ cd ~/.kde4/share/apps/amarok </kbd><br/><kbd>$ /usr/sbin/mysqld --defaults-file=`pwd`/my.cnf --default-storage-engine=MyISAM --datadir=`pwd`/mysqle --socket=`pwd`/sock --skip-grant-tables </kbd></p><p>Teraz pozostaje utworzyć zrzut bazy amaroka:</p><p><kbd>$ mysqldump -S sock amarok &gt; amarok.sql </kbd></p><p>Po wykonaniu zrzuty możemy już zatrzymać serwer z bazą amarok i uruchomić serwer z konfiguracją globalną.</p><p><kbd># systemctl start mysql </kbd></p><p>Następnie konieczne jest utworzenie bazy danych, do której zaimportujemy dane z zrzutu.<br/>Tworzymy bazę i użytkownika:</p><p><kbd>&gt; CREATE USER 'amarok'@'localhost' IDENTIFIED BY 'amarok'; </kbd><br/><kbd>&gt; CREATE DATABASE `amarok`; </kbd><br/><kbd>&gt; GRANT ALL PRIVILEGES ON amarok.* to 'amarok'@'localhost' IDENTIFIED BY 'amarok'; </kbd></p><p>Importujemy zrzut do nowej bazy:</p><p><kbd>$ mysql -u amarok -p amarok &lt; amarok.sql </kbd></p><p>Teraz pozostaje tylko skonfigurować amaroka, aby korzystał z zewnętrznej bazy danych. Dane muszą być oczywiście takie jakich użyliśmy przed chwilą.</p><p><img src="/img/2013/amarok-system-mariadb.png" alt="Konfiguracja amaroka i zewnętrznej bazy""/></p><h3>digiKam</h3><p>Zaczniemy od utworzenia 2 nowych baz dla digiKama i użytkownika dla tych baz.</p><p><kbd>&gt; CREATE USER 'digikam'@'localhost' IDENTIFIED BY 'digikam'; </kbd><br/><kbd>&gt; CREATE DATABASE `digikam`; </kbd><br/><kbd>&gt; CREATE DATABASE `thumbnails-digikam`; </kbd><br/><kbd>&gt; GRANT ALL PRIVILEGES ON digikam.* to 'digikam'@'localhost' IDENTIFIED BY 'digikam'; </kbd><br/><kbd>&gt; GRANT ALL PRIVILEGES ON thumbnails-digikam.* to 'digikam'@'localhost' IDENTIFIED BY 'digikam'; </kbd></p><p>Następnie korzystamy z wbudowanego w digiKam narzędzia do migracji bazy danych. W tym celu uruchamiamy digiKam i z menu <code>Ustawienienia</code> wybieramy <code>Migracja bazy danych</code>. W lewej części okna wybieramy sqlite i podajemy ścieżkę gdzie są aktualnie bazy przechowywane. Domyślnie jest to <code>~/Obrazy</code>. W prawej części okna uzupełniamy dane niezbędne do połączenia z bazą mysql/mariadb.</p><p><img src="/img/2013/digikam-system-mariadb.png" alt="Migracja sqlite do mariadb w digiKam""/></p><p>Pozostaje sprawdzić połączenie i zmigrować naszą bazę sqlite do mysql/mariadb przez naciśnięcie przycisku <code>Migruj -&gt;</code>.<br/>Czas migracji zależny jest od wielkości naszej kolekcji oraz wydajności naszego sprzętu, zwłaszcza dysku twardego i procesora. Po migracji ostatnim krokiem jest skonfigurowanie digiKama, aby korzystał z bazy mysql/mariadb. Z menu <code>Ustawienia</code> wybieramy <code>Konfiguracja: digiKam...</code> i w sekcji <code>Baza danych</code> należy wybrać MySQL i uzupełnić dane połączenia.</p><p><img src="/img/2013/digikam-use-system-mariadb.png" alt="Konfiguracja mysql w digiKam""/></p><p>UWAGA! Jeśli z komputera korzysta kilku użytkowników, należy dla każdego użytkownika utworzyć osobną bazę. Jako nazwę dla baz, można użyć schematu <code>$USER_akonadi</code>, <code>$USER_amarok</code> i <code>$USER_digikam</code>.</p></p>
      <div class="share">
        <div class="social">
  <!-- Facebook -->
          <span class="facebook">
            <iframe src="//www.facebook.com/plugins/like.php?href=http://fisiu.github.io2013/konsolidacja-baz-mysql-dla-aplikacji-kde-w-opensuse.html&layout=button_count&action=like&show_faces=false&share=false&height=21&appId=631359390268930" scrolling="no" frameborder="0" allowTransparency="true"></iframe>
          </span>
  <!-- Google+ -->
          <span class="google">
            <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
            <g:plusone size="medium" href="http://fisiu.github.io2013/konsolidacja-baz-mysql-dla-aplikacji-kde-w-opensuse.html"></g:plusone>
          </span>
  <!-- Twitter -->
          <span class="twitter">
            <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://fisiu.github.io2013/konsolidacja-baz-mysql-dla-aplikacji-kde-w-opensuse.html">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
          </span>
        </div>
      </div>
<hr>
<section class="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'fisiu-github-io'; // required: replace example with your forum shortname
  
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>            </article>
        </div> <!-- /.col-md-12 -->
      </div> <!-- /.row -->
        
      </div><!-- /.container -->

    <footer>
      <div class="container">
        <hr>
        <div class="row">
          <div class="col-xs-10">
            <p class="text-muted credit">&copy; Mariusz Fik 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.3.0</a> | Baked with <a href="http://jbake.org">JBake v2.3.2</a> | <i title="Linux" class="fa fa-linux"></i></p>
          </div>
          <div class="col-xs-2 gotop">
            <a href="#"><i class="fa fa-arrow-circle-up"> do góry</i></a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/1.6/gist-embed.min.js"></script>
    <script src="/js/cookies.js"></script>
    <script src="/js/jquery.image-scale.js"></script>
    
    <script type="text/javascript">
      $(document).ready(function() {
        $('article > p > img').imageScale({
          parent_css_selector: null, // Defaults to the image's immediate parent.
          scale: 'fit',
          center: true,
          fade_duration: 0, // Fading is disabled if set to 0.
          rescale_after_resize: true
        });
      });
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
    <script type="text/javascript">
      <!-- load prettify only when needed -->
      $(document).ready(function(){
        var prettify = false;
        var classToAdd = 'prettyprint snippet';
        $("pre > code").each(function() {
          $("pre > code").parent().addClass(classToAdd);
          prettify = true;
        });
        if(prettify) {
          prettyPrint();
        }
      });
    </script>

    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'fisiu-github-io'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    </script>

      
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2256304-7']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
